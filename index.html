<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Galactic Legends: Survival Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #bf00ff;
            --danger: #ff0055;
            --power: #39ff14;
            --coin: #ffd700;
            --bg-dark: #050a14;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-dark);
            font-family: 'Rajdhani', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            cursor: default;
        }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; cursor: crosshair; }

        /* UI BASE */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; }
        .interactive { pointer-events: auto; cursor: pointer; }
        .hidden { display: none !important; }

        /* MENU SCREEN */
        #menu-screen {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(30,10,50,0.6), #050a14 90%);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20;
        }
        .title-main {
            font-size: 3rem; font-weight: 900; line-height: 0.9; color: #fff;
            letter-spacing: 4px; text-shadow: 0 0 25px rgba(0, 242, 255, 0.6);
            margin-bottom: 20px; text-align: center; position: absolute; top: 10%;
        }
        
        /* PC CONTROLS HINT - Solo visible en PC (hover supported) */
        .pc-controls-hint {
            position: absolute; bottom: 30px; 
            display: flex; gap: 20px; align-items: center;
            opacity: 0.7;
        }
        .control-group {
            display: flex; align-items: center; gap: 8px;
            background: rgba(0,0,0,0.6); padding: 6px 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        .key-box { 
            color: #000; background: var(--primary); font-weight: 800; 
            padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;
            box-shadow: 0 0 5px var(--primary);
        }
        .icon-hint { font-size: 1.2rem; filter: grayscale(100%) brightness(200%); }

        /* Media Query para ocultar controles de PC en m√≥viles */
        @media (hover: none) and (pointer: coarse) {
            .pc-controls-hint { display: none !important; }
            .key-badge { display: none !important; }
        }

        .player-wealth {
            position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 8px;
            background: rgba(0,0,0,0.8); padding: 8px 18px; border-radius: 30px; border: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .coin-icon-sm { width: 18px; height: 18px; background: var(--coin); border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 8px var(--coin); }
        .coin-text { color: #fff; font-weight: 800; font-size: 1.1rem; }

        /* SHIP SELECTOR */
        .ship-showcase { position: relative; width: 240px; height: 240px; display: flex; align-items: center; justify-content: center; }
        .ring { position: absolute; border-radius: 50%; border: 1px solid rgba(255,255,255,0.05); }
        .r1 { width: 100%; height: 100%; border-color: rgba(0,242,255,0.15); animation: spin 25s linear infinite; }
        .r2 { width: 75%; height: 75%; border-style: dashed; animation: spin-rev 20s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes spin-rev { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
        #ship-touch-zone { position: absolute; width: 100%; height: 100%; border-radius: 50%; z-index: 30; cursor: pointer; }

        .ship-meta { position: absolute; bottom: 22%; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .ship-name { font-size: 1.4rem; font-weight: 800; letter-spacing: 3px; color: var(--primary); text-shadow: 0 0 10px currentColor; }
        .dots { display: flex; gap: 6px; }
        .dot { width: 6px; height: 6px; background: #333; border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #fff; box-shadow: 0 0 8px #fff; transform: scale(1.3); }

        /* CONTROLS */
        .menu-controls { position: absolute; bottom: 12%; display: flex; gap: 15px; }
        .btn-icon {
            width: 65px; height: 65px; border-radius: 16px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(8px); transition: all 0.2s; color: #fff;
        }
        .btn-icon:active { transform: scale(0.92); background: rgba(255,255,255,0.2); }
        .btn-play { border-bottom: 4px solid var(--primary); }
        .btn-pvp { border-bottom: 4px solid var(--danger); }
        .btn-survival { border-bottom: 4px solid #f00; } /* Nuevo Bot√≥n */
        .btn-shop { border-bottom: 4px solid var(--coin); }
        .btn-icon svg { width: 30px; height: 30px; fill: currentColor; }

        /* SHOP */
        #shop-screen {
            position: absolute; width: 100%; height: 100%; background: rgba(5, 8, 15, 0.98); z-index: 30;
            display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto;
        }
        .shop-title { font-size: 2.5rem; color: var(--coin); font-weight: 900; margin-bottom: 20px; letter-spacing: 3px; text-shadow: 0 0 15px var(--coin); }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; max-width: 450px; padding-bottom: 80px; }
        .shop-item {
            background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.08)); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; 
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .shop-item h3 { color: #fff; font-weight: 800; margin-bottom: 3px; font-size: 0.9rem; letter-spacing: 1px; }
        .shop-item p { color: #aaa; font-size: 0.65rem; margin-bottom: 8px; height: 24px; line-height: 1.2; }
        .shop-price { color: var(--coin); font-weight: 800; display: flex; align-items: center; gap: 5px; font-size: 1rem; }
        .btn-buy {
            margin-top: 8px; background: var(--primary); color: #000; font-weight: 800;
            padding: 6px 18px; border-radius: 20px; font-size: 0.75rem; width: 100%;
        }
        .btn-buy:active { transform: scale(0.95); }
        .btn-buy:disabled { background: #333; color: #555; }

        /* HUD */
        #hud { display: flex; justify-content: space-between; padding: 15px; width: 100%; align-items: flex-start; pointer-events: none; }
        .hud-left { pointer-events: auto; }
        .score-display { font-size: 2rem; font-weight: 900; color: #fff; line-height: 1; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .combo-text { font-size: 1rem; color: #ffcc00; font-weight: 800; font-style: italic; opacity: 0; transition: opacity 0.2s; }
        .label { font-size: 0.6rem; color: #888; letter-spacing: 1px; font-weight: 700; display: block; }
        
        .bar-wrap { width: 140px; height: 8px; background: #222; margin-top: 4px; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #00f2ff, #0088ff); width: 100%; transition: width 0.2s; }
        
        .power-container { margin-top: 8px; display: flex; align-items: center; gap: 6px; }
        .power-bar-bg { width: 100px; height: 6px; background: #221a00; border-radius: 3px; border: 1px solid #443300; }
        .power-bar-fill { height: 100%; background: var(--power); width: 0%; transition: width 0.2s; box-shadow: 0 0 8px var(--power); }
        .power-text { font-size: 1.1rem; font-weight: 800; color: var(--power); }

        /* ABILITIES */
        .ability-controls { position: absolute; right: 20px; bottom: 40px; display: flex; flex-direction: column; gap: 20px; pointer-events: auto; }
        .ab-btn {
            width: 65px; height: 65px; border-radius: 50%;
            background: rgba(0,0,0,0.6); border: 2px solid #666;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; font-weight: 800; position: relative;
            backdrop-filter: blur(4px); transition: transform 0.1s; cursor: pointer;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .ab-btn:active { transform: scale(0.9); }
        .ab-btn:hover { border-color: #fff; background: rgba(255,255,255,0.1); }
        
        /* Icons inside buttons */
        .ab-icon { width: 30px; height: 30px; fill: currentColor; }
        
        /* PC Key Hint */
        .key-badge {
            position: absolute; bottom: -8px; background: #222; color: #aaa;
            font-size: 0.6rem; padding: 1px 5px; border-radius: 4px; border: 1px solid #555;
        }

        .ab-count { 
            position: absolute; top: -5px; right: -5px; 
            background: #f00; color: #fff; font-size: 0.9rem; font-weight: bold;
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #fff;
            display: flex; align-items: center; justify-content: center;
            z-index: 5;
        }
        .ab-bomb { border-color: var(--danger); color: var(--danger); }
        .ab-hyper { border-color: var(--power); color: var(--power); }
        .ab-shield { border-color: #00f2ff; color: #00f2ff; }

        /* PAUSE & GAMEOVER */
        .btn-pause { width: 45px; height: 45px; border-radius: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; color: #fff; margin-bottom: 10px; cursor: pointer; }
        .btn-pause:hover { background: rgba(255,255,255,0.2); }
        #pause-menu, #game-over { position: absolute; width: 100%; height: 100%; background: rgba(5,8,15,0.95); z-index: 60; display: flex; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .btn-menu { padding: 15px 50px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: #fff; font-weight: 800; letter-spacing: 2px; margin: 10px; border-radius: 6px; font-size: 1rem; cursor: pointer; }
        .btn-menu:hover { background: rgba(255,255,255,0.2); }
        
        #matchmaking-screen { position: absolute; width: 100%; height: 100%; background: #050a14; z-index: 50; display: flex; justify-content: center; align-items: center; }
        .radar { width: 70px; height: 70px; border: 3px solid var(--danger); border-radius: 50%; position: relative; box-shadow: 0 0 15px var(--danger); }
        .radar::after { content: ''; position: absolute; top: 50%; left: 50%; width: 50%; height: 2px; background: var(--danger); transform-origin: 0 0; animation: radar-spin 1.2s linear infinite; }
        @keyframes radar-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #rival-hud { position: absolute; top: 80px; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .rival-frame { background: rgba(30, 0, 10, 0.9); border: 2px solid var(--danger); padding: 6px 20px; border-radius: 20px; box-shadow: 0 0 10px var(--danger); }
        .rival-hp-bg { width: 120px; height: 6px; background: #300; border-radius: 3px; margin-top: 2px; }
        .rival-hp-fill { height: 100%; background: var(--danger); width: 100%; transition: width 0.1s; }

        /* DMG FLASH */
        #dmg-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, rgba(255,0,0,0.3) 100%);
            opacity: 0; pointer-events: none; z-index: 5; transition: opacity 0.1s;
        }

    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    <div id="dmg-overlay"></div>

    <div id="ui-layer">
        
        <!-- MENU -->
        <div id="menu-screen" class="interactive">
            <div class="player-wealth">
                <div class="coin-icon-sm"></div>
                <span class="coin-text" id="menu-coins">0</span>
            </div>

            <div class="title-main">GALACTIC<br>LEGENDS</div>
            
            <div class="ship-showcase">
                <div class="ring r1"></div><div class="ring r2"></div>
                <div id="ship-touch-zone" onclick="nextShip()"></div>
            </div>
            
            <div class="ship-meta">
                <div class="dots" id="dots-box"></div>
                <div id="ship-name" class="ship-name">ALPHA</div>
                <div id="ship-desc" class="text-gray-400 text-xs tracking-widest mt-1">EQUILIBRADA</div>
            </div>
            
            <div class="menu-controls">
                <button class="btn-icon btn-play" onclick="startCampaign()" title="CAMPA√ëA"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button class="btn-icon btn-survival" onclick="startSurvival()" title="SUPERVIVENCIA"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 4c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0 10c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm0 4c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></button>
                <button class="btn-icon btn-pvp" onclick="startPvP()" title="PVP"><svg viewBox="0 0 24 24"><path d="M6 15c2.5 0 3.5 2 6 2s3.5-2 6-2v-4c-2.5 0-3.5 2-6 2s-3.5-2-6-2v4zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg></button>
                <button class="btn-icon btn-shop" onclick="openShop()" title="TIENDA"><svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg></button>
            </div>
            
            <div class="pc-controls-hint">
                <div class="control-group">
                    <span class="key-box">WASD</span>
                    <span class="icon-hint">üñ±Ô∏è</span>
                </div>
                <div class="control-group">
                    <span class="key-box">1-3</span>
                    <span class="icon-hint">‚ö°</span>
                </div>
                <div class="control-group">
                    <span class="key-box">ESC</span>
                    <span class="icon-hint">‚è∏</span>
                </div>
            </div>
        </div>

        <!-- SHOP -->
        <div id="shop-screen" class="interactive hidden">
            <div class="player-wealth" style="position:static; margin-bottom:10px;">
                <div class="coin-icon-sm"></div>
                <span class="coin-text" id="shop-coins">0</span>
            </div>
            <h2 class="shop-title">MERCADO NEGRO</h2>
            <div class="shop-grid">
                <!-- Consumables -->
                <div class="shop-item">
                    <h3>BOMBA PULSO</h3> <p>Destruye todo enemigo en pantalla.</p>
                    <div class="shop-price"><div class="coin-icon-sm"></div> 100</div>
                    <button class="btn-buy" onclick="buyItem('bomb', 100)">COMPRAR</button>
                    <div class="text-xs text-gray-500 mt-1">TIENES: <span id="own-bomb">0</span></div>
                </div>
                <div class="shop-item">
                    <h3>HIPER N√öCLEO</h3> <p>Sube Poder al Nivel M√°ximo.</p>
                    <div class="shop-price"><div class="coin-icon-sm"></div> 250</div>
                    <button class="btn-buy" onclick="buyItem('hyper', 250)">COMPRAR</button>
                    <div class="text-xs text-gray-500 mt-1">TIENES: <span id="own-hyper">0</span></div>
                </div>
                <div class="shop-item">
                    <h3>ESCUDO TEMP</h3> <p>Invencibilidad por 10 seg.</p>
                    <div class="shop-price"><div class="coin-icon-sm"></div> 150</div>
                    <button class="btn-buy" onclick="buyItem('shield', 150)">COMPRAR</button>
                    <div class="text-xs text-gray-500 mt-1">TIENES: <span id="own-shield">0</span></div>
                </div>
                <!-- Upgrades -->
                <div class="shop-item" style="border-color: #ffd700;">
                    <h3 style="color:#ffd700">IM√ÅN MK-II</h3> <p>Atrae items desde m√°s lejos (Pasivo).</p>
                    <div class="shop-price"><div class="coin-icon-sm"></div> 500</div>
                    <button class="btn-buy" id="btn-magnet" onclick="buyUpgrade('magnet', 500)">MEJORAR</button>
                    <div class="text-xs text-gray-500 mt-1">NIVEL: <span id="lvl-magnet">0</span></div>
                </div>
                <div class="shop-item" style="border-color: #f0f;">
                    <h3 style="color:#f0f">VIDA EXTRA</h3> <p>Revive 1 vez al morir (Pasivo).</p>
                    <div class="shop-price"><div class="coin-icon-sm"></div> 1000</div>
                    <button class="btn-buy" id="btn-revive" onclick="buyUpgrade('revive', 1000)">COMPRAR</button>
                    <div class="text-xs text-gray-500 mt-1">ACTIVO: <span id="has-revive">NO</span></div>
                </div>
                <div class="shop-item" style="border-color: #0ff;">
                    <h3 style="color:#0ff">DA√ëO MEJORADO</h3> <p>+10% Da√±o de armas (Pasivo).</p>
                    <div class="shop-price"><div class="coin-icon-sm"></div> 800</div>
                    <button class="btn-buy" id="btn-dmg" onclick="buyUpgrade('dmg', 800)">MEJORAR</button>
                    <div class="text-xs text-gray-500 mt-1">NIVEL: <span id="lvl-dmg">0</span></div>
                </div>
                <!-- Fixed Missing Item: Auto-Repair -->
                <div class="shop-item" style="border-color: #0f0;">
                    <h3 style="color:#0f0">AUTO-REPARAR</h3> <p>Regenera salud lentamente (Pasivo).</p>
                    <div class="shop-price"><div class="coin-icon-sm"></div> 1200</div>
                    <button class="btn-buy" id="btn-regen" onclick="buyUpgrade('regen', 1200)">MEJORAR</button>
                    <div class="text-xs text-gray-500 mt-1">NIVEL: <span id="lvl-regen">0</span></div>
                </div>
            </div>
            <button class="btn-menu" onclick="closeShop()" style="margin-top: auto;">VOLVER</button>
        </div>

        <!-- MATCHMAKING -->
        <div id="matchmaking-screen" class="hidden"><div class="radar"></div><p class="text-xs text-red-500 mt-4 tracking-widest font-bold animate-pulse">BUSCANDO RIVAL...</p></div>

        <!-- HUD -->
        <div id="hud" class="hidden">
            <div class="hud-left interactive">
                <button class="btn-pause" onclick="togglePause()"><svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>
                <span class="label">PUNTOS</span>
                <span class="score-display" id="score-text">0000</span>
                <div id="combo-display" class="combo-text">COMBO x2</div>
            </div>
            
            <div style="display:flex; flex-direction:column; align-items:flex-end;">
                <span class="label">ESCUDO</span>
                <div class="bar-wrap"><div id="hp-bar" class="hp-fill"></div></div>
                <div class="power-container">
                    <div class="power-bar-bg"><div id="power-bar" class="power-bar-fill"></div></div>
                    <div class="power-text" id="power-text">0</div>
                </div>
                <span class="label" style="font-size: 0.5rem; margin-top: 2px; color: #39ff14;">NIVEL DE N√öCLEO</span>
            </div>
            
            <!-- ABILITY BUTTONS (Updated with SVG Icons, no text) -->
            <div class="ability-controls">
                <div class="ab-btn ab-bomb interactive" onclick="activateItem('bomb')">
                    <!-- Skull Icon -->
                    <svg class="ab-icon" viewBox="0 0 24 24"><path d="M12 2C7.58 2 4 5.58 4 10c0 2.42 1.09 4.58 2.8 6h10.4c1.71-1.42 2.8-3.58 2.8-6 0-4.42-3.58-8-8-8zm0 13c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm4-4h-8v-2h8v2z"/></svg>
                    <div class="ab-count" id="hud-bomb-count">0</div>
                    <div class="key-badge">1</div>
                </div>
                <div class="ab-btn ab-hyper interactive" onclick="activateItem('hyper')">
                    <!-- Bolt Icon -->
                    <svg class="ab-icon" viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
                    <div class="ab-count" id="hud-hyper-count">0</div>
                    <div class="key-badge">2</div>
                </div>
                <div class="ab-btn ab-shield interactive" onclick="activateItem('shield')">
                    <!-- Shield Icon -->
                    <svg class="ab-icon" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 6c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z"/></svg>
                    <div class="ab-count" id="hud-shield-count">0</div>
                    <div class="key-badge">3</div>
                </div>
            </div>
        </div>

        <!-- PAUSE MENU -->
        <div id="pause-menu" class="hidden interactive">
            <div class="pause-title">PAUSA</div>
            <button class="btn-menu" onclick="togglePause()">REANUDAR</button>
            <button class="btn-menu" style="border-color: #f55; color: #f55;" onclick="toMenu()">SALIR</button>
        </div>

        <!-- RIVAL HUD -->
        <div id="rival-hud" class="hidden">
            <div class="rival-frame"><span class="rival-label">ENEMIGO</span><div class="rival-hp-bg"><div id="rival-hp-bar" class="rival-hp-fill"></div></div></div>
        </div>

        <!-- GAME OVER -->
        <div id="game-over" class="hidden interactive">
            <h2 id="go-title" class="text-5xl font-black text-white mb-2">FIN</h2>
            <p id="go-score" class="text-3xl text-cyan-400 font-bold mb-2">0 PTS</p>
            <p id="go-reward" class="text-lg text-yellow-400 font-bold mb-8">+0 MONEDAS</p>
            <button class="btn-menu" onclick="toMenu()">CONTINUAR</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        // UI References
        const menuScreen = document.getElementById('menu-screen');
        const shopScreen = document.getElementById('shop-screen');
        const hud = document.getElementById('hud');
        const pauseMenu = document.getElementById('pause-menu');
        const matchmaking = document.getElementById('matchmaking-screen');
        const rivalHud = document.getElementById('rival-hud');
        const gameOverScreen = document.getElementById('game-over');
        const comboDisplay = document.getElementById('combo-display');
        const dmgOverlay = document.getElementById('dmg-overlay');
        
        // Save Data Management
        let saveData = { coins: 200, bombs: 0, hypers: 0, shields: 0, magnetLevel: 0, dmgLevel: 0, regenLevel: 0, hasRevive: false };
        try {
            const stored = localStorage.getItem('galactic_legends_omega');
            if(stored) saveData = Object.assign(saveData, JSON.parse(stored));
        } catch(e) {}

        const updateSave = () => {
            localStorage.setItem('galactic_legends_omega', JSON.stringify(saveData));
            updateUI();
        };

        const updateUI = () => {
            ['menu-coins','shop-coins'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerText = saveData.coins;
            });
            
            const setText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            
            setText('own-bomb', saveData.bombs);
            setText('own-hyper', saveData.hypers);
            setText('own-shield', saveData.shields);
            
            setText('hud-bomb-count', saveData.bombs);
            setText('hud-hyper-count', saveData.hypers);
            setText('hud-shield-count', saveData.shields);

            // Upgrades UI
            setText('lvl-magnet', saveData.magnetLevel);
            setText('lvl-dmg', saveData.dmgLevel);
            setText('lvl-regen', saveData.regenLevel); // Safety check added
            
            const hasReviveEl = document.getElementById('has-revive');
            if(hasReviveEl) hasReviveEl.innerText = saveData.hasRevive ? "S√ç" : "NO";
            
            const btnRevive = document.getElementById('btn-revive');
            if(btnRevive) {
                btnRevive.disabled = saveData.hasRevive;
                btnRevive.innerText = saveData.hasRevive ? "COMPRADO" : "COMPRAR";
            }

            // HIDE BUTTONS IF COUNT IS 0
            const setDisplay = (sel, cond) => { const el = document.querySelector(sel); if(el) el.style.display = cond ? 'flex' : 'none'; };
            setDisplay('.ab-bomb', saveData.bombs > 0);
            setDisplay('.ab-hyper', saveData.hypers > 0);
            setDisplay('.ab-shield', saveData.shields > 0);
        };

        // Game State
        let width, height;
        let state = 'MENU';
        let frameCount = 0;
        let score = 0;
        let earnedCoins = 0;
        let isPaused = false;
        let touch = { active: false, x: 0, y: 0, sx: 0, sy: 0 };
        
        // PC INPUTS
        const keys = { w: false, a: false, s: false, d: false, ArrowUp: false, ArrowLeft: false, ArrowDown: false, ArrowRight: false };

        let difficultyFactor = 0;
        let revivedThisGame = false;
        let combo = 0;
        let comboTimer = 0;

        let player, rival, bullets = [], enemies = [], powerUps = [], coins = [], stars = [], particles = [], texts = [];
        let gridOffset = 0; // For moving background grid

        // --- SHIPS (6 Total) ---
        const SHIPS = [
            { name: "ALPHA", desc: "EQUILIBRADA", color: "#00f2ff", type: "ultimate", rate: 10 },
            { name: "VIPER", desc: "VELOZ", color: "#00ff88", type: "speed", rate: 8 },
            { name: "TITAN", desc: "PESADA", color: "#ffaa00", type: "power", rate: 20 },
            { name: "PHANTOM", desc: "SIGILO", color: "#bf00ff", type: "stealth", rate: 6 },
            { name: "OBLIVION", desc: "DESTRUCTOR", color: "#ff3333", type: "nuke", rate: 25 },
            { name: "CELESTIAL", desc: "DIVINO", color: "#ffd700", type: "arc", rate: 12 }
        ];
        let currentShip = 0;

        function nextShip() { 
            currentShip = (currentShip + 1) % SHIPS.length; 
            updateMenuUI(); 
        }

        function updateMenuUI() {
            const s = SHIPS[currentShip];
            document.getElementById('ship-name').innerText = s.name; 
            document.getElementById('ship-name').style.color = s.color;
            document.getElementById('ship-desc').innerText = s.desc;
            
            const box = document.getElementById('dots-box');
            box.innerHTML = '';
            SHIPS.forEach((_, i) => {
                const d = document.createElement('div');
                d.className = i === currentShip ? 'dot active' : 'dot';
                box.appendChild(d);
            });
            updateUI();
        }

        // --- SHOP & ITEMS ---
        function openShop() { menuScreen.classList.add('hidden'); shopScreen.classList.remove('hidden'); updateUI(); }
        function closeShop() { shopScreen.classList.add('hidden'); menuScreen.classList.remove('hidden'); }
        
        function buyItem(item, price) {
            if (saveData.coins >= price) {
                saveData.coins -= price;
                if (item === 'bomb') saveData.bombs++;
                if (item === 'hyper') saveData.hypers++;
                if (item === 'shield') saveData.shields++;
                updateSave();
            }
        }

        function buyUpgrade(item, price) {
            if (saveData.coins >= price) {
                if(item === 'magnet') { saveData.coins -= price; saveData.magnetLevel++; }
                if(item === 'dmg') { saveData.coins -= price; saveData.dmgLevel++; }
                if(item === 'regen') { saveData.coins -= price; saveData.regenLevel++; }
                if(item === 'revive' && !saveData.hasRevive) { saveData.coins -= price; saveData.hasRevive = true; }
                updateSave();
            }
        }

        function activateItem(item) {
            if ((state !== 'SOLO' && state !== 'PVP' && state !== 'SURVIVAL') || isPaused) return;
            
            if (item === 'bomb' && saveData.bombs > 0) {
                saveData.bombs--;
                enemies.forEach(e => {
                    e.active = false; score += e.score;
                    createExplosion(e.x, e.y, e.color, 20);
                    spawnCoin(e.x, e.y); 
                    spawnFloatText(e.x, e.y, "NUKE!", "#f00");
                });
                bullets = bullets.filter(b => b.isP);
                ctx.fillStyle = '#fff'; ctx.fillRect(0,0,width,height); 
            }
            if (item === 'hyper' && saveData.hypers > 0) {
                saveData.hypers--;
                player.power = 10;
                spawnFloatText(player.x, player.y - 40, "MAX POWER", "#0ff");
            }
            if (item === 'shield' && saveData.shields > 0) {
                saveData.shields--;
                player.invincible = 600; // 10 seconds (60fps * 10)
                spawnFloatText(player.x, player.y - 40, "SHIELD UP", "#00f2ff");
            }
            updateSave();
        }

        // --- VISUALS ---
        function spawnFloatText(x, y, text, color) {
            texts.push({x: x, y: y, text: text, color: color, alpha: 1.0, life: 60});
        }
        
        function createExplosion(x, y, color, count=10) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x, y: y, 
                    vx: (Math.random()-0.5)*8, vy: (Math.random()-0.5)*8, 
                    color: color, life: 1.0, size: Math.random()*3+1
                });
            }
        }

        function addCombo() {
            combo++;
            comboTimer = 120; // 2 seconds to keep combo
            if(combo > 1) {
                comboDisplay.innerText = "COMBO x" + combo;
                comboDisplay.style.opacity = 1;
                score += combo * 10;
            }
        }

        // --- DRAWING ---
        function drawShipModel(ctx, x, y, typeObj, s = 1, forceColor = null) {
            ctx.save(); ctx.translate(x, y); ctx.scale(s, s);
            const color = forceColor || typeObj.color;
            
            // Invincibility visual only if blinking
            if(player && player.invincible > 0 && Math.floor(frameCount/5)%2===0 && !forceColor) ctx.globalAlpha = 0.5;

            // DRAW ENGINE THRUST
            if(!forceColor) {
                 ctx.save();
                 // Scale thrust based on movement/time
                 const thrustScale = 1 + Math.sin(frameCount * 0.5) * 0.2;
                 ctx.translate(0, 30);
                 ctx.fillStyle = '#0ff';
                 ctx.globalAlpha = 0.6;
                 ctx.beginPath();
                 ctx.moveTo(-5, 0); ctx.lineTo(5, 0); ctx.lineTo(0, 20 * thrustScale); 
                 ctx.fill();
                 ctx.restore();
            }

            if (typeObj.type === 'ultimate') {
                const t = (Math.sin(frameCount*0.2)*3)+10; ctx.shadowBlur = 10; ctx.shadowColor = color;
                ctx.fillStyle = forceColor ? '#900' : '#0ea5e9'; [-12, 12].forEach(ox => { ctx.beginPath(); ctx.moveTo(ox-4, 25); ctx.lineTo(ox, 25+t); ctx.lineTo(ox+4, 25); ctx.fill(); });
                ctx.shadowBlur = 0; ctx.fillStyle = forceColor ? '#500' : '#1e3a8a'; ctx.beginPath(); ctx.moveTo(0,-45); ctx.lineTo(45,35); ctx.lineTo(0,25); ctx.lineTo(-45,35); ctx.fill();
                ctx.fillStyle = forceColor ? '#f00' : '#3b82f6'; ctx.beginPath(); ctx.moveTo(0,-55); ctx.lineTo(12,-10); ctx.lineTo(35,15); ctx.lineTo(15,35); ctx.lineTo(0,25); ctx.lineTo(-15,35); ctx.lineTo(-35,15); ctx.lineTo(-12,-10); ctx.fill();
                ctx.shadowBlur = 15; ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();
            } else if (typeObj.type === 'speed') {
                ctx.shadowBlur = 10; ctx.shadowColor = color; ctx.fillStyle = color;
                ctx.beginPath(); ctx.moveTo(0,-35); ctx.lineTo(12,25); ctx.lineTo(0,35); ctx.lineTo(-12,25); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.moveTo(0,-5); ctx.lineTo(3,10); ctx.lineTo(-3,10); ctx.fill();
            } else if (typeObj.type === 'stealth') {
                ctx.shadowBlur = 15; ctx.shadowColor = color;
                ctx.fillStyle = color; ctx.beginPath(); ctx.moveTo(0,-40); ctx.lineTo(15,0); ctx.lineTo(25,20); ctx.lineTo(0,10); ctx.lineTo(-25,20); ctx.lineTo(-15,0); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(2,20); ctx.lineTo(-2,20); ctx.fill();
            } else if (typeObj.type === 'nuke') {
                ctx.shadowBlur = 20; ctx.shadowColor = color;
                ctx.fillStyle = '#300'; ctx.beginPath(); ctx.moveTo(0,-40); ctx.lineTo(25,10); ctx.lineTo(35,35); ctx.lineTo(0,25); ctx.lineTo(-35,35); ctx.lineTo(-25,10); ctx.fill();
                ctx.fillStyle = color; ctx.fillRect(-4,-45,8,40); ctx.fillRect(-20,10,10,20); ctx.fillRect(10,10,10,20);
            } else if (typeObj.type === 'arc') { 
                ctx.shadowBlur = 20; ctx.shadowColor = '#ffd700';
                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0,0,15,0,Math.PI*2); ctx.fill();
                ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(0,0,22,0,Math.PI*2); ctx.stroke();
                ctx.fillStyle = '#ffd700'; 
                ctx.beginPath(); ctx.moveTo(15,0); ctx.quadraticCurveTo(40,-10, 30,30); ctx.lineTo(10,10); ctx.fill();
                ctx.beginPath(); ctx.moveTo(-15,0); ctx.quadraticCurveTo(-40,-10, -30,30); ctx.lineTo(-10,10); ctx.fill();
            } else { 
                ctx.shadowBlur = 10; ctx.shadowColor = color; ctx.fillStyle = forceColor ? '#420' : '#78350f'; ctx.fillRect(-22,-20,44,40);
                ctx.fillStyle = color; ctx.beginPath(); ctx.moveTo(-22,-20); ctx.lineTo(0,-40); ctx.lineTo(22,-20); ctx.fill();
            }
            ctx.globalAlpha = 1;
            
            // FORCE FIELD
            if(player && player.invincible > 0 && !forceColor) {
                 ctx.strokeStyle = '#00f2ff'; 
                 ctx.lineWidth = 2; 
                 ctx.beginPath(); 
                 // Rotating ring
                 const r = 50;
                 ctx.arc(0,0,r,0,Math.PI*2); 
                 ctx.stroke();
                 // Inner rotating arcs
                 ctx.save();
                 ctx.rotate(frameCount * 0.1);
                 ctx.beginPath(); ctx.arc(0,0,r-5, 0, Math.PI); ctx.stroke();
                 ctx.restore();
                 
                 ctx.fillStyle = 'rgba(0, 242, 255, 0.1)';
                 ctx.fill();
            }
            ctx.restore();
        }

        // --- CLASSES ---
        class Bullet {
            constructor(x,y,type,isP,ang=0) {
                this.x=x;this.y=y;this.type=type;this.isP=isP;this.active=true;
                let dmgMult = 1 + (saveData.dmgLevel * 0.1);
                
                // Projectiles
                if(type==='beam'){this.vx=0;this.vy=-14;this.w=6;this.h=40;this.dmg=3*dmgMult;this.c='#f44';}
                else if(type==='p_std'){this.vx=0;this.vy=-12;this.w=4;this.h=12;this.dmg=2*dmgMult;this.c='#0ff';}
                else if(type==='phantom_shot'){this.vx=0;this.vy=-18;this.w=3;this.h=15;this.dmg=1.5*dmgMult;this.c='#bf00ff';} 
                else if(type==='doomsday'){this.vx=0;this.vy=-6;this.w=40;this.h=80;this.dmg=20*dmgMult;this.c='#f00';}
                else if(type==='arc_bolt'){this.vx=0;this.vy=-15;this.w=10;this.h=30;this.dmg=4*dmgMult;this.c='#ffd700';}
                else if(type==='plasma'){this.vx=0;this.vy=-6;this.w=14;this.h=14;this.dmg=6*dmgMult;this.c='#fa0';}
                
                // Abilities
                else if(type==='minibot'){ this.vx=0; this.vy=0; this.w=50; this.h=50; this.dmg = state==='PVP'?0.5:5; this.c='#fff'; this.permanent = true; this.tracking = true; } 
                else if(type==='laser_ult'){ this.vx=0;this.vy=-20;this.w=30;this.h=120;this.dmg=50*dmgMult;this.c='#0f0'; } 
                else if(type==='rock'){ this.vx=0;this.vy=-3; this.w=50;this.h=50;this.dmg=60*dmgMult;this.c='#8b4513'; this.homing=true; }
                else if(type==='shadow_clone'){ this.vx=0;this.vy=0; this.w=0;this.h=0; this.dmg=0; this.permanent=true; this.timer=600; }
                else if(type==='nova'){ this.r=10; this.maxR=150; this.dmg=5*dmgMult; this.permanent=true; this.isNova=true; }
                
                else { this.vx=Math.cos(ang)*3; this.vy=Math.sin(ang)*3; this.w=6;this.h=6;this.c='#f0f'; } 
            }

            update(){
                if(this.isNova) {
                    this.r += 10;
                    if(this.r > this.maxR) this.active = false;
                    this.x = player.x; this.y = player.y;
                    return;
                }

                if(this.type === 'doomsday') {
                    if(frameCount%4===0) particles.push({x:this.x,y:this.y+40,vx:0,vy:2,color:'#f55',life:0.5,size:4});
                }

                if(this.type === 'arc_bolt') {
                    // Slight zigzag
                    this.x += Math.sin(frameCount*0.5)*5;
                    particles.push({x:this.x,y:this.y,vx:0,vy:0,color:'#ffd700',life:0.3,size:2});
                }

                if(this.type === 'shadow_clone') {
                    this.timer--; if(this.timer<=0) this.active=false;
                    if(this.timer % 10 === 0) bullets.push(new Bullet(this.x, this.y-20, 'phantom_shot', true));
                    return; 
                }

                if(this.permanent && player && this.tracking) {
                    let target = null;
                    const searchRange = 250; const maxLeash = 350; 
                    const destX = player.x + 60; const destY = player.y;
                    if (Math.hypot(this.x-player.x, this.y-player.y) < maxLeash) {
                        if (state === 'SOLO' || state === 'SURVIVAL') {
                            let minD = searchRange;
                            enemies.forEach(e => { if(e.active) { const d = Math.hypot(e.x-this.x, e.y-this.y); if (d < minD) { minD = d; target = e; } } });
                        } else if (state === 'PVP' && rival && rival.hp > 0) {
                            if (Math.hypot(rival.x-this.x, rival.y-this.y) < searchRange) target = rival;
                        }
                    }
                    if (target) { this.x += (target.x - this.x) * 0.08; this.y += (target.y - this.y) * 0.08; } 
                    else { this.x += (destX - this.x) * 0.1; this.y += (destY - this.y) * 0.1; }
                    return; 
                }
                if(this.homing) {
                    let target = null; let minD = 9999;
                    if (state === 'SOLO' || state === 'SURVIVAL') { enemies.forEach(e => { if(e.active) { const d = Math.hypot(e.x-this.x, e.y-this.y); if(d < minD) { minD = d; target = e; } } }); } 
                    else if (state === 'PVP' && rival.hp > 0) { target = rival; }
                    if(target) { const ang = Math.atan2(target.y - this.y, target.x - this.x); this.vx = Math.cos(ang) * 5; this.vy = Math.sin(ang) * 5; }
                }
                this.x+=this.vx;this.y+=this.vy;
                if(this.y<-200||this.y>height+50||this.x<-50||this.x>width+50)this.active=false;
            }

            draw(){
                if(this.isNova) {
                    ctx.save(); ctx.translate(this.x,this.y);
                    ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2);
                    ctx.strokeStyle = '#ffd700'; ctx.lineWidth = 5; ctx.stroke();
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.2)'; ctx.fill();
                    ctx.restore();
                    return;
                }

                ctx.save();ctx.translate(this.x,this.y);
                if(this.type==='minibot'){ 
                    const p = Math.sin(frameCount*0.1)*5; ctx.shadowBlur=15; ctx.shadowColor='#0ff';
                    ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(0,0,18,0,Math.PI*2); ctx.fill(); 
                    ctx.strokeStyle='#0ff'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,25+p,0,Math.PI*2); ctx.stroke();
                    ctx.fillStyle = state==='PVP'?'#f00':'#000'; ctx.beginPath(); ctx.arc(-7,-4,3,0,Math.PI*2); ctx.arc(7,-4,3,0,Math.PI*2); ctx.fill(); ctx.shadowBlur=0;
                }
                else if(this.type==='rock'){ ctx.rotate(frameCount*0.1); ctx.fillStyle='#8b4513'; ctx.beginPath(); ctx.moveTo(0,-20); ctx.lineTo(18,10); ctx.lineTo(-8,22); ctx.lineTo(-22,-8); ctx.fill(); ctx.strokeStyle='#5c2a05'; ctx.lineWidth=2; ctx.stroke(); }
                else if(this.type==='laser_ult'){ ctx.fillStyle='rgba(0,255,0,0.8)'; ctx.fillRect(-15,-60,30,120); ctx.fillStyle='#fff'; ctx.fillRect(-5,-60,10,120); ctx.shadowBlur=15; ctx.shadowColor='#0f0'; }
                else if(this.type==='shadow_clone'){ ctx.globalAlpha = 0.6; drawShipModel(ctx, 0, 0, {type:'stealth',color:'#bf00ff'}, 0.8); }
                else if(this.type==='phantom_shot'){ ctx.fillStyle='#bf00ff'; ctx.fillRect(-2,-7,4,14); ctx.shadowBlur=5; ctx.shadowColor='#bf00ff'; }
                else if(this.type==='arc_bolt'){ ctx.fillStyle='#fff'; ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(5,0); ctx.lineTo(0,10); ctx.lineTo(-5,0); ctx.fill(); ctx.shadowBlur=10; ctx.shadowColor='#ffd700'; }
                else if(this.type==='doomsday'){ 
                    ctx.fillStyle='#f00'; ctx.beginPath(); ctx.moveTo(0,-40); ctx.lineTo(15,10); ctx.lineTo(0,40); ctx.lineTo(-15,10); ctx.fill(); 
                    ctx.fillStyle='#fff'; ctx.fillRect(-5,-30,10,60); ctx.shadowBlur=15; ctx.shadowColor='#f00';
                }
                else if(this.type==='plasma'){ctx.fillStyle=this.c;ctx.beginPath();ctx.arc(0,0,8,0,Math.PI*2);ctx.fill();}
                else {ctx.fillStyle=this.c;ctx.fillRect(-this.w/2,-this.h/2,this.w,this.h);}
                ctx.restore();
            }
        }

        class PowerUp {
            constructor(x, y) { this.x = x; this.y = y; this.active = true; this.vy = 1.0; this.bob = Math.random()*10; }
            update() { 
                this.y += this.vy; 
                if(player) {
                    const dist = Math.hypot(this.x - player.x, this.y - player.y);
                    const magnetRange = 80 + (saveData.magnetLevel * 40); 
                    if(dist < magnetRange) {
                        this.x += (player.x - this.x) * 0.15;
                        this.y += (player.y - this.y) * 0.15;
                    }
                }
                if(this.y > height + 20) this.active = false; 
            }
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); 
                const s = 1 + Math.sin((frameCount+this.bob)*0.1)*0.1;
                ctx.scale(s, s);
                ctx.shadowBlur=20; ctx.shadowColor='#39ff14'; 
                ctx.fillStyle = '#000'; ctx.strokeStyle='#39ff14'; ctx.lineWidth=2;
                ctx.fillRect(-12,-12,24,24); ctx.strokeRect(-12,-12,24,24);
                ctx.fillStyle = '#39ff14';
                ctx.beginPath(); ctx.moveTo(2,-8); ctx.lineTo(-8,0); ctx.lineTo(-2,0); ctx.lineTo(-4,8); ctx.lineTo(6,0); ctx.lineTo(0,0); ctx.fill();
                ctx.restore(); 
            }
        }

        class Coin {
            constructor(x, y) { this.x = x; this.y = y; this.active = true; this.vy = 1.0; }
            update() { 
                this.y += this.vy; 
                if(player) {
                    const dist = Math.hypot(this.x - player.x, this.y - player.y);
                    const magnetRange = 80 + (saveData.magnetLevel * 40);
                    if(dist < magnetRange) {
                        this.x += (player.x - this.x) * 0.15;
                        this.y += (player.y - this.y) * 0.15;
                    }
                }
                if(this.y > height + 20) this.active = false; 
            }
            draw() { 
                ctx.save(); ctx.translate(this.x, this.y); 
                const scaleX = Math.abs(Math.cos(frameCount * 0.1));
                ctx.scale(scaleX, 1);
                ctx.shadowBlur=10; ctx.shadowColor='#ffd700';
                ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(0,0,10,0,Math.PI*2); ctx.fill(); 
                ctx.fillStyle='#b8860b'; ctx.fillRect(-3,-6,6,12);
                ctx.restore(); 
            }
        }

        // --- GAME SYSTEM ---
        function spawnPowerUp(x, y) { if (Math.random() < 0.15) powerUps.push(new PowerUp(x, y)); } // Slightly higher rate
        function spawnCoin(x, y) { if (Math.random() < 0.15) coins.push(new Coin(x, y)); }

        function collectPowerUp() { 
            if(player.power < 10) player.power++; 
            score += 50; 
            spawnFloatText(player.x, player.y-30, "POWER UP!", "#39ff14");
        }
        function collectCoin() { 
            earnedCoins++; score+=100; 
            spawnFloatText(player.x, player.y-30, "+1 CR", "#ffd700");
        }

        function togglePause() { if (state !== 'SOLO' && state !== 'PVP' && state !== 'SURVIVAL') return; isPaused = !isPaused; if (isPaused) pauseMenu.classList.remove('hidden'); else pauseMenu.classList.add('hidden'); }
        function startCampaign() { menuScreen.classList.add('hidden'); hud.classList.remove('hidden'); state = 'SOLO'; resetGame(); }
        function startSurvival() { menuScreen.classList.add('hidden'); hud.classList.remove('hidden'); state = 'SURVIVAL'; resetGame(); }
        function startPvP() {
            menuScreen.classList.add('hidden'); matchmaking.classList.remove('hidden');
            const randomShipIdx = Math.floor(Math.random() * SHIPS.length);
            setTimeout(() => { matchmaking.classList.add('hidden'); hud.classList.remove('hidden'); rivalHud.classList.remove('hidden'); state = 'PVP'; resetGame(); rival = { x: width/2, y: 80, hp: 1000, maxHp: 1000, tx: width/2, ship: SHIPS[randomShipIdx] }; }, 2000);
        }
        function toMenu() { 
            state = 'MENU'; isPaused = false; 
            menuScreen.classList.remove('hidden'); hud.classList.add('hidden'); rivalHud.classList.add('hidden'); gameOverScreen.classList.add('hidden'); pauseMenu.classList.add('hidden'); shopScreen.classList.add('hidden');
            updateUI();
        }
        function resetGame() {
            player = { x: width/2, y: height-120, hp: 100, maxHp: 100, ship: SHIPS[currentShip], power: 0, abilityTimer: 0, invincible: 0 };
            bullets=[]; enemies=[]; powerUps=[]; coins=[]; particles=[]; texts=[]; score=0; earnedCoins=0; difficultyFactor = 0; revivedThisGame = false;
            combo = 0; comboTimer = 0;
            updateUI();
            isPaused = false;
        }

        function spawnEnemy() {
            // Updated Stats (HARDCORE MODE)
            const enemyTypes = [
                { type: 'BASIC', hp: 20, speed: 1.2, color: '#f05', score: 50, size: 30 }, 
                { type: 'FAST', hp: 10, speed: 1.8, color: '#0f5', score: 80, size: 25 },  
                { type: 'TANK', hp: 60, speed: 0.6, color: '#50f', score: 150, size: 45 }, 
                { type: 'SPINNER', hp: 25, speed: 1.5, color: '#ff0', score: 90, size: 30 }, 
                { type: 'STEALTH', hp: 15, speed: 2.2, color: '#333', score: 100, size: 28, alpha: 0.4 }, 
                { type: 'HEAVY', hp: 100, speed: 0.3, color: '#444', score: 200, size: 55 }, 
                { type: 'SWARM', hp: 5, speed: 2.0, color: '#f0f', score: 30, size: 22 },   
                { type: 'SNIPER', hp: 30, speed: 1.0, color: '#00f', score: 120, size: 28 }, 
                { type: 'KAMIKAZE', hp: 15, speed: 4.0, color: '#f00', score: 120, size: 30 } 
            ];

            const r = Math.random();
            let idx = 0; 
            if(r > 0.4) idx = 1; 
            if(r > 0.6) idx = 3; 
            if(r > 0.75) idx = 4; 
            if(r > 0.82) idx = 8; 
            if(r > 0.88) idx = 7; 
            if(r > 0.92) idx = 6; 
            if(r > 0.96) idx = 2; 
            if(r > 0.99) idx = 5; 
            
            let type = enemyTypes[idx];
            const speedMult = 1 + (difficultyFactor * 0.05);
            
            // In survival mode, enemies are slightly faster
            const modeMult = state === 'SURVIVAL' ? 1.3 : 1;
            const actualSpeed = type.speed * speedMult * modeMult;

            if(type.type === 'SWARM') {
                for(let i=0; i<3; i++) enemies.push({x: Math.random()*(width-40)+20, y: -30 - (i*45), hp: type.hp, active: true, speed: actualSpeed, color: type.color, score: type.score, size: type.size, type: type.type});
            } else {
                enemies.push({x: Math.random()*(width-40)+20, y: -30, hp: type.hp, active: true, speed: actualSpeed, color: type.color, score: type.score, size: type.size, type: type.type, alpha: type.alpha || 1});
            }
        }

        // --- PC INPUT HANDLING ---
        window.addEventListener('keydown', e => { 
            if(keys.hasOwnProperty(e.key)) keys[e.key] = true;
            if(e.key.toLowerCase() === 'w') keys.w = true;
            if(e.key.toLowerCase() === 'a') keys.a = true;
            if(e.key.toLowerCase() === 's') keys.s = true;
            if(e.key.toLowerCase() === 'd') keys.d = true;
            // Hotkeys
            if(e.key === '1') activateItem('bomb');
            if(e.key === '2') activateItem('hyper');
            if(e.key === '3') activateItem('shield');
            if(e.key === 'Escape') togglePause();
        });
        window.addEventListener('keyup', e => { 
            if(keys.hasOwnProperty(e.key)) keys[e.key] = false; 
            if(e.key.toLowerCase() === 'w') keys.w = false;
            if(e.key.toLowerCase() === 'a') keys.a = false;
            if(e.key.toLowerCase() === 's') keys.s = false;
            if(e.key.toLowerCase() === 'd') keys.d = false;
        });

        // Mouse Handlers
        window.addEventListener('mousedown', e => {
            if(e.target.closest('.interactive')) return;
            touch.active = true; touch.sx = e.clientX; touch.sy = e.clientY;
        });
        window.addEventListener('mousemove', e => {
            if(touch.active && !isPaused && (state==='SOLO'||state==='PVP'||state==='SURVIVAL')) {
                const x = e.clientX; const y = e.clientY;
                player.x += (x - touch.sx) * 1.5;
                player.y += (y - touch.sy) * 1.5;
                player.x = Math.max(20, Math.min(width-20, player.x)); 
                player.y = Math.max(50, Math.min(height-40, player.y));
                touch.sx = x; touch.sy = y;
            }
        });
        window.addEventListener('mouseup', () => { touch.active = false; });
        window.addEventListener('mouseleave', () => { touch.active = false; });


        function loop() {
            if (!isPaused) {
                // CYBER BACKGROUND
                if (state === 'SURVIVAL') {
                    ctx.fillStyle = "#1a0505"; // Reddish background for survival
                } else {
                    ctx.fillStyle = "#050a14"; 
                }
                ctx.fillRect(0,0,width,height);
                
                // GRID EFFECT
                gridOffset = (gridOffset + 1) % 40;
                ctx.beginPath();
                ctx.strokeStyle = state === 'SURVIVAL' ? 'rgba(255, 50, 50, 0.1)' : 'rgba(0, 242, 255, 0.05)';
                ctx.lineWidth = 1;
                for(let i=0; i<width; i+=40) { ctx.moveTo(i, 0); ctx.lineTo(i, height); }
                for(let i=gridOffset; i<height; i+=40) { ctx.moveTo(0, i); ctx.lineTo(width, i); }
                ctx.stroke();

                // STARS
                ctx.fillStyle = "#fff";
                stars.forEach(s => { 
                    s.y += (state==='MENU'?0.1:2) * s.s; 
                    if(s.y>height) s.y=0; 
                    ctx.globalAlpha = Math.random()*0.4 + (s.s*0.3); 
                    ctx.fillRect(s.x, s.y, s.s, s.s); 
                });
                ctx.globalAlpha=1;

                if (state === 'MENU') {
                    const rect = document.querySelector('.ship-showcase').getBoundingClientRect();
                    drawShipModel(ctx, rect.left + rect.width/2, rect.top + rect.height/2, SHIPS[currentShip], 2.2);
                }
                else {
                    if(state === 'SOLO') difficultyFactor += 0.0003;
                    if(state === 'SURVIVAL') difficultyFactor += 0.0008; // Faster difficulty scaling

                    if(player.invincible > 0) player.invincible--;
                    
                    if(saveData.regenLevel > 0 && frameCount % 60 === 0) {
                        if(player.hp < player.maxHp) player.hp += saveData.regenLevel;
                    }

                    if(comboTimer > 0) comboTimer--;
                    if(comboTimer <= 0) { combo = 0; comboDisplay.style.opacity = 0; }

                    // KEYBOARD MOVEMENT
                    const kSpeed = 12; // Increased speed for PC
                    if (keys.ArrowUp || keys.w) player.y -= kSpeed;
                    if (keys.ArrowDown || keys.s) player.y += kSpeed;
                    if (keys.ArrowLeft || keys.a) player.x -= kSpeed;
                    if (keys.ArrowRight || keys.d) player.x += kSpeed;
                    player.x = Math.max(20, Math.min(width-20, player.x)); 
                    player.y = Math.max(50, Math.min(height-40, player.y));

                    // --- PLAYER SHOOTING ---
                    const currentRate = Math.max(5, Math.floor(player.ship.rate - (player.power * 0.3)));
                    if(frameCount % currentRate === 0) {
                        const t = player.ship.type;
                        if(t==='ultimate'){ bullets.push(new Bullet(player.x,player.y-25,'beam',true)); bullets.push(new Bullet(player.x-15,player.y-10,'p_std',true)); bullets.push(new Bullet(player.x+15,player.y-10,'p_std',true)); } 
                        else if(t==='power') { bullets.push(new Bullet(player.x,player.y-30,'plasma',true)); } 
                        else if(t==='stealth') { bullets.push(new Bullet(player.x,player.y-20,'phantom_shot',true)); bullets.push(new Bullet(player.x-10,player.y-10,'phantom_shot',true)); bullets.push(new Bullet(player.x+10,player.y-10,'phantom_shot',true));}
                        else if(t==='nuke') { bullets.push(new Bullet(player.x,player.y-40,'doomsday',true)); }
                        else if(t==='arc') { bullets.push(new Bullet(player.x,player.y-30,'arc_bolt',true)); } 
                        else { bullets.push(new Bullet(player.x-8,player.y-20,'p_std',true)); bullets.push(new Bullet(player.x+8,player.y-20,'p_std',true)); }
                    }

                    // --- ABILITIES ---
                    if (player.power >= 5) {
                        player.abilityTimer++; const sType = player.ship.type;
                        if (sType === 'ultimate' && !bullets.some(b => b.type === 'minibot' && b.active)) bullets.push(new Bullet(player.x + 50, player.y, 'minibot', true));
                        if (sType === 'speed' && player.abilityTimer % 180 === 0) bullets.push(new Bullet(player.x, player.y - 60, 'laser_ult', true));
                        if (sType === 'power' && player.abilityTimer % 150 === 0) bullets.push(new Bullet(player.x, player.y - 50, 'rock', true));
                        if (sType === 'stealth' && player.abilityTimer % 300 === 0) bullets.push(new Bullet(player.x - 50, player.y, 'shadow_clone', true));
                        if (sType === 'arc' && player.abilityTimer % 200 === 0) bullets.push(new Bullet(player.x, player.y, 'nova', true));
                    }

                    // --- CAMPAIGN / SURVIVAL ENEMIES ---
                    if(state === 'SOLO' || state === 'SURVIVAL') {
                        // Spawn rate: Campaign = 70, Survival = 45 (Faster)
                        const spawnRate = state === 'SURVIVAL' ? 45 : 70;
                        if(frameCount % spawnRate === 0) spawnEnemy();
                        
                        enemies.forEach(e => {
                            if(e.type === 'KAMIKAZE') {
                                const angle = Math.atan2(player.y - e.y, player.x - e.x);
                                e.x += Math.cos(angle) * e.speed;
                                e.y += Math.sin(angle) * e.speed;
                            } else {
                                e.y += e.speed;
                            }
                            
                            ctx.save(); ctx.translate(e.x,e.y); ctx.globalAlpha = e.alpha || 1;
                            ctx.shadowBlur = 5; ctx.shadowColor = e.color; ctx.fillStyle = e.color;
                            
                            // DRAW ENEMY BODIES & FACES
                            ctx.beginPath();
                            if (e.type === 'SPINNER') { ctx.rotate(frameCount*0.2); ctx.rect(-e.size/2,-e.size/2,e.size,e.size); }
                            else if (e.type === 'KAMIKAZE') { 
                                const angle = Math.atan2(player.y - e.y, player.x - e.x);
                                ctx.rotate(angle - Math.PI/2);
                                ctx.moveTo(0, e.size); ctx.lineTo(e.size/1.5, -e.size); ctx.lineTo(-e.size/1.5, -e.size); 
                            }
                            else if (e.type === 'STEALTH') { ctx.moveTo(0,e.size/2); ctx.lineTo(e.size/2,-e.size/2); ctx.lineTo(0,-e.size/4); ctx.lineTo(-e.size/2,-e.size/2); }
                            else if (e.type === 'HEAVY') { for(let i=0;i<6;i++) ctx.lineTo(e.size*0.8*Math.cos(i*Math.PI/3), e.size*0.8*Math.sin(i*Math.PI/3)); }
                            else if (e.type === 'SNIPER') { ctx.arc(0,0,e.size/2.5,0,Math.PI*2); ctx.moveTo(0,-e.size/1.5);ctx.lineTo(0,e.size/1.5); ctx.moveTo(-e.size/1.5,0);ctx.lineTo(e.size/1.5,0); ctx.stroke(); }
                            else if (e.type === 'SWARM') { ctx.arc(0,0,e.size/2,0,Math.PI*2); }
                            else if (e.type === 'TANK') { ctx.rect(-e.size/2, -e.size/2, e.size, e.size); }
                            else { ctx.moveTo(0,e.size/2); ctx.lineTo(e.size/2,-e.size/2); ctx.lineTo(-e.size/2,-e.size/2); } 
                            ctx.fill();

                            // DRAW FACES (White Eyes)
                            if(e.type !== 'SNIPER' && e.type !== 'KAMIKAZE') {
                                ctx.fillStyle = '#fff'; ctx.shadowBlur = 0;
                                ctx.beginPath(); ctx.arc(-e.size/4, -e.size/4, e.size/8, 0, Math.PI*2); ctx.fill(); // Left Eye
                                ctx.beginPath(); ctx.arc(e.size/4, -e.size/4, e.size/8, 0, Math.PI*2); ctx.fill();  // Right Eye
                                // Mouth
                                ctx.beginPath(); 
                                if(e.type==='HEAVY' || e.type==='TANK') ctx.rect(-e.size/4, e.size/8, e.size/2, e.size/8); // Grumpy mouth
                                else ctx.arc(0, 0, e.size/4, 0.2, Math.PI-0.2); // Smile
                                ctx.fill();
                            }
                            // Kamikaze Face (Cyclops)
                            if(e.type === 'KAMIKAZE') {
                                ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, -e.size/4, e.size/4, 0, Math.PI*2); ctx.fill();
                            }

                            ctx.restore();

                            if(Math.hypot(e.x-player.x, e.y-player.y)<(e.size + 10)) { 
                                if(player.invincible <= 0) { 
                                    player.hp-=20; player.invincible = 30; 
                                    dmgOverlay.style.opacity = 1; setTimeout(()=>dmgOverlay.style.opacity=0, 100);
                                }
                                e.active=false; 
                                createExplosion(e.x, e.y, e.color, 10);
                            }
                            if(e.y>height+50) { e.active=false; }
                        });
                        enemies=enemies.filter(e=>e.active);
                    } 
                    // --- PVP RIVAL ---
                    else if (state === 'PVP' && rival.hp > 0) {
                        if(frameCount%60===0) rival.tx = Math.random()*(width-60)+30;
                        rival.x += (rival.tx - rival.x)*0.05;
                        if (frameCount % 180 === 0) powerUps.push(new PowerUp(rival.x, rival.y));
                        if(frameCount%60===0) bullets.push(new Bullet(rival.x,rival.y+30,'enemy',false, Math.atan2(player.y-rival.y, player.x-rival.x)));
                        ctx.save(); ctx.translate(rival.x,rival.y); ctx.scale(1,-1); drawShipModel(ctx, 0, 0, rival.ship, 0.8, '#ff0055'); ctx.restore();
                        document.getElementById('rival-hp-bar').style.width = (rival.hp / rival.maxHp * 100) + "%";
                    }

                    // --- COLLISIONS ---
                    bullets.forEach(b => {
                        b.update(); b.draw();
                        if(b.active && b.isP) {
                            if(state==='SOLO' || state==='SURVIVAL') enemies.forEach(e=>{
                                let hitR = e.size + 15; if (b.type === 'minibot' || b.type === 'rock' || b.type === 'nova') hitR += 30;
                                if(e.active && Math.hypot(b.x-e.x,b.y-e.y) < hitR){
                                    e.hp -= b.dmg; 
                                    if(!['minibot','laser_ult','rock','shadow_clone','doomsday','nova'].includes(b.type)) b.active=false; 
                                    if(b.type === 'rock') b.active = false;
                                    createExplosion(b.x, b.y, b.c, 3);
                                    if(e.hp<=0){ 
                                        e.active=false; score += e.score; spawnPowerUp(e.x, e.y); spawnCoin(e.x, e.y); 
                                        createExplosion(e.x, e.y, e.color, 15);
                                        addCombo();
                                        spawnFloatText(e.x, e.y, "+"+e.score, "#fff");
                                    }
                                }
                            });
                            if(state==='PVP' && Math.hypot(b.x-rival.x,b.y-rival.y)<40){
                                rival.hp-=b.dmg; 
                                createExplosion(b.x, b.y, '#f00', 5);
                                if(!['minibot','laser_ult','shadow_clone','nova'].includes(b.type)) b.active=false;
                                if(rival.hp<=0) gameOver(true);
                            }
                        } else if(b.active && !b.isP && Math.hypot(b.x-player.x,b.y-player.y)<25) {
                            if(player.invincible <= 0) { 
                                player.hp-=5; b.active=false; 
                                dmgOverlay.style.opacity = 1; setTimeout(()=>dmgOverlay.style.opacity=0, 100);
                            }
                        }
                    });
                    bullets=bullets.filter(b=>b.active);

                    // Fixed Collection Logic
                    if(player) {
                        powerUps.forEach(p => { p.update(); p.draw(); if(p.active && Math.hypot(p.x-player.x, p.y-player.y) < 50) { p.active = false; collectPowerUp(); } });
                        powerUps=powerUps.filter(p=>p.active);
                        coins.forEach(c => { c.update(); c.draw(); if(c.active && Math.hypot(c.x-player.x, c.y-player.y) < 50) { c.active = false; collectCoin(); } });
                        coins=coins.filter(c=>c.active);
                    }

                    // --- PARTICLES & TEXT ---
                    particles.forEach(p => { 
                        p.x+=p.vx; p.y+=p.vy; p.life-=0.05; 
                        ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); 
                    });
                    particles = particles.filter(p=>p.life>0); ctx.globalAlpha=1;

                    texts.forEach(t => {
                        t.y-=1.5; t.life--; ctx.globalAlpha = Math.min(1, t.life/30);
                        ctx.fillStyle = t.color; ctx.font = "bold 16px Rajdhani"; ctx.fillText(t.text, t.x-20, t.y);
                    });
                    texts = texts.filter(t=>t.life>0); ctx.globalAlpha=1;

                    drawShipModel(ctx, player.x, player.y, player.ship, 1);
                    document.getElementById('score-text').innerText = score.toString().padStart(4,'0');
                    document.getElementById('hp-bar').style.width = Math.max(0,player.hp)+'%';
                    document.getElementById('power-bar').style.width = (player.power * 10) + '%';
                    document.getElementById('power-text').innerText = player.power; // FIX: Update power text
                    
                    if(player.hp<=0) {
                        if(saveData.hasRevive && !revivedThisGame) {
                            revivedThisGame = true; player.hp = 50; player.invincible = 300; saveData.hasRevive = false; 
                            createExplosion(player.x, player.y, '#fff', 30); spawnFloatText(player.x, player.y, "REVIVED!", "#fff");
                            updateSave();
                        } else {
                            gameOver(false);
                        }
                    }
                }
                frameCount++;
            }
            requestAnimationFrame(loop);
        }

        function gameOver(win) {
            state = 'GAMEOVER';
            saveData.coins += earnedCoins;
            if(win && state==='PVP') { earnedCoins += 50; saveData.coins += 50; }
            if(state==='SURVIVAL') { earnedCoins += Math.floor(score/100); saveData.coins += Math.floor(score/100); }
            updateSave();
            
            document.getElementById('go-title').innerText = win ? "VICTORIA" : "DERROTA";
            document.getElementById('go-title').style.color = win ? "#00f2ff" : "#fff";
            document.getElementById('go-score').innerText = score + " PTS";
            document.getElementById('go-reward').innerText = "+" + earnedCoins + " MONEDAS";
            
            hud.classList.add('hidden'); rivalHud.classList.add('hidden'); gameOverScreen.classList.remove('hidden'); pauseMenu.classList.add('hidden');
        }

        // BUG FIX: Only resize, don't reset game
        function handleResize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            // Re-generate stars to cover new area if needed, or just let them loop
            if (stars.length < 80) {
                 stars=Array(80).fill().map(()=>({x:Math.random()*width,y:Math.random()*height,s:Math.random()*2+0.5}));
            }
        }

        function init() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            stars=Array(80).fill().map(()=>({x:Math.random()*width,y:Math.random()*height,s:Math.random()*2+0.5}));
            updateMenuUI();
            requestAnimationFrame(loop);
        }

        window.addEventListener('touchstart', e=>{
            if(e.target.closest('.interactive')) return;
            e.preventDefault(); touch.active=true; touch.sx=e.touches[0].clientX; touch.sy=e.touches[0].clientY;
        },{passive:false});
        window.addEventListener('touchmove', e=>{
            if(e.target.closest('.interactive')) return;
            e.preventDefault();
            if(touch.active && !isPaused && (state==='SOLO'||state==='PVP'||state==='SURVIVAL')) {
                const x=e.touches[0].clientX; const y=e.touches[0].clientY;
                player.x += (x-touch.sx)*1.5; player.y += (y-touch.sy)*1.5;
                player.x = Math.max(20, Math.min(width-20, player.x)); player.y = Math.max(50, Math.min(height-40, player.y));
                touch.sx=x; touch.sy=y;
            }
        },{passive:false});
        window.addEventListener('resize', handleResize);
        
        init();
    </script>
</body>
</html>